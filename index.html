<!DOCTYPE html>
<html>
  <head>
    <title>Severus Prototype</title> 
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content= "width=device-width, user-scalable=no">

    <link rel="stylesheet" href="css/master.css">
    <link rel="manifest" href="json/manifest.json">
  </head>
  <body id="Body">
    <div id='Wrapper' class='wrapper'>
      <header>
        <h1 id="HeaderText">
          <!-- //////////////////////////////////// -->
          <!-- //////// headline goes here //////// -->
          <!-- //////////////////////////////////// -->
        </h1>
        <div class='progressBar-wrapper'>
          <div class='progressBar-bg'>
            <div class='progressBar-bar'></div>
          </div>
        </div> <!--  / .progressBar_wrapper -->
      </header>
      <div id="Card-Wrapper" class='card-wrapper'>
      <!-- //////////////////////////////////// -->
      <!-- //////// content goes here ///////// -->
      <!-- //////////////////////////////////// -->
      </div> <!--  / .content_wrapper -->

      <div class='btn-wrapper'>
        <button id="Btn_Next" class='btn btn-primary'>Next</button>
        <button id="Btn_Previous" class='btn btn-secondary'>Previous</button>
      </div>

    </div> <!--  / #Wrapper -->


    <div class="overlayPanel wrapper"></div> <!--  / .overlayPanel -->
    <div class="finishedOverlay wrapper">

      <h1>Complete!</h1>

      <div class='btn-wrapper'>
        <button id="Btn_Continue" class='btn btn-primary'>Continue</button>
      </div>
    </div> <!--  / .overlayPanel -->

  </body>

</html>


  <script src="js/scripts.js"></script>
  <script src="lib/jquery-3.2.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.js"></script>
  <script src="lib/jquery.ui.touch-punch.min.js"></script>
  <script src="lib/handlebars-v4.2.0.js"></script>


  <!-- //////////////////////////////// -->
  <!-- //////// Card templates ///////////// -->
  <!-- //////////////////////////////// -->

  <script id="Card-Template-1" type="text/x-handlebars-template">
    <div class='content-card'>

      <p>{{headline}}</p>
      <h2>{{question}}</h2>

      <ul class="question-list">
        {{#each answers}}
          <li class="answerRadio">
            <input type="radio" id="radio_{{answer}}" name="radio" />
            <label for="radio_{{answer}}"><span class="wrap"><span class="bullet"></span></span>{{answer}}</label>
          </li>
        {{/each}}
      </ul>

      <div id="SlideContainer">
        <div class="slideWrapper">
          <div class="rangeOutput" id="rangeOutput">5</div>
          <div class="slidecontainer">
            <input type="range" min="0" max="10" value="5" class="slider" id="myRange">
          </div>
          <div>Strongly disagree = 0</div>
          <div>Strongly agree = 10</div>
        </div>
      </div>

    </div>
  </script>

  <script id="Card-Template-2" type="text/x-handlebars-template">
    <div class='content-card v2'>

      <p>{{headline}}</p>
      <h2>{{question}}</h2>

      <ul class="question-list v2">
        {{#each answers}}
          <li class="answerTag">
            {{answer}}
          </li>
        {{/each}}
      </ul>

      <div id="SlideContainer">
        <div class="slideWrapper">
          <div class="svg-arrow">
            <svg width="25px" height="20px" viewBox="0 0 25 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                <g id="Assessment-Flow-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                    <g id="Intro-to-ISI-Q3-Copy-7" transform="translate(-175.000000, -283.000000)" fill="#FFFFFF">
                        <path d="M189.182357,285.617 L199.019026,300.918485 C199.61633,301.847625 199.347324,303.085053 198.418184,303.682357 C198.09559,303.889739 197.720172,304 197.336669,304 L177.663331,304 C176.558761,304 175.663331,303.104569 175.663331,302 C175.663331,301.616497 175.773592,301.241079 175.980974,300.918485 L185.817643,285.617 C186.414947,284.68786 187.652375,284.418854 188.581515,285.016158 C188.82252,285.17109 189.027425,285.375994 189.182357,285.617 Z" id="Triangle" transform="translate(187.500000, 293.500000) scale(1, -1) translate(-187.500000, -293.500000) "></path>
                    </g>
                </g>
            </svg>
          </div>

            <div class="slideTrack">

              <div class='snaptargets'>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
              </div>

              <!-- draggable -->
              <div class="slideRibbon">
                <ul class="slideItems">
                  <li class="slideItem item0">0</li>
                  <li class="slideItem item1">1</li>
                  <li class="slideItem item2">2</li>
                  <li class="slideItem item3">3</li>
                  <li class="slideItem item4">4</li>
                  <li class="slideItem item5">5</li>
                  <li class="slideItem item6">6</li>
                  <li class="slideItem item7">7</li>
                  <li class="slideItem item8">8</li>
                  <li class="slideItem item9">9</li>
                  <li class="slideItem item10">10</li>
                </ul>
              </div>
              <!-- draggable -->

            </div>

          <div class="slideLegend">
            <div>Strongly disagree = 0</div>
            <div>Strongly agree = 10</div>
          </div>

        </div>
      </div>

    </div>
  </script>

  <script id="Card-Template-3" type="text/x-handlebars-template">
    <div class='content-card v3'>

      <p>{{headline}}</p>
      <h2>{{question}}</h2>

      <ul class="question-list v2">
        {{#each answers}}
          <li class="answerTagAutoAdvance">
            {{answer}}
          </li>
        {{/each}}
      </ul>

      <div id="SlideContainer">
        <div class="slideWrapper">
          <div class="svg-arrow">
            <svg width="25px" height="20px" viewBox="0 0 25 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                <g id="Assessment-Flow-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                    <g id="Intro-to-ISI-Q3-Copy-7" transform="translate(-175.000000, -283.000000)" fill="#FFFFFF">
                        <path d="M189.182357,285.617 L199.019026,300.918485 C199.61633,301.847625 199.347324,303.085053 198.418184,303.682357 C198.09559,303.889739 197.720172,304 197.336669,304 L177.663331,304 C176.558761,304 175.663331,303.104569 175.663331,302 C175.663331,301.616497 175.773592,301.241079 175.980974,300.918485 L185.817643,285.617 C186.414947,284.68786 187.652375,284.418854 188.581515,285.016158 C188.82252,285.17109 189.027425,285.375994 189.182357,285.617 Z" id="Triangle" transform="translate(187.500000, 293.500000) scale(1, -1) translate(-187.500000, -293.500000) "></path>
                    </g>
                </g>
            </svg>
          </div>

            <div class="slideTrack">

              <div class='snaptargets'>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
                <div class='snaptarget'></div>
              </div>

              <!-- draggable -->
              <div class="slideRibbon">
                <ul class="slideItems">
                  <li class="slideItem item0">0</li>
                  <li class="slideItem item1">1</li>
                  <li class="slideItem item2">2</li>
                  <li class="slideItem item3">3</li>
                  <li class="slideItem item4">4</li>
                  <li class="slideItem item5">5</li>
                  <li class="slideItem item6">6</li>
                  <li class="slideItem item7">7</li>
                  <li class="slideItem item8">8</li>
                  <li class="slideItem item9">9</li>
                  <li class="slideItem item10">10</li>
                </ul>
              </div>
              <!-- draggable -->

            </div>

          <div class="slideLegend">
            <div>Strongly disagree = 0</div>
            <div>Strongly agree = 10</div>
          </div>

        </div>
      </div>

    </div>
  </script>

  <!-- //////////////////////////////// -->
  <!-- //////// Panel template ///////////// -->
  <!-- //////////////////////////////// -->

  <script id="Panel-Template" type="text/x-handlebars-template">
    <div class="panelContent">

      <h2>{{panelHeading}}</h2>
      <p>{{panelBody}}</p>

      <div class='btn-wrapper'>
        <button id="Btn_Start" class='btn btn-primary'>{{btnLabel}}</button>
      </div>

    </div>
  </script>


  <script type="text/javascript">

    var numCurrentQ;
    var numTotalQ;

    var currentQuestionNum;
    var currentSection;

    var depressionQuestions;
    var insomniaQuestions;
    var anxietyQuestions;
    var beliefQuestions;

    var questionSet;
    var questionText;
    var answers;

    var cardTemplateSource;
    var cardTemplateClean;

    var panelTemplateSource;
    var panelTemplateClean;

    var appVersion;




    $(function(){


      ////////////////////////////////
      ////// page load  //////////////
      ////////////////////////////////

      // what version do we show
      const params = new URLSearchParams(window.location.search);
      const vNum = params.get("version");


      // set the card template, appVersion variable and body class for this version
      switch(vNum){
        case "1":
          appVersion = '1';
          $('#Body').addClass('v1');
          cardTemplateSource = document.getElementById("Card-Template-1").innerHTML;
          console.log("showing version "+vNum);
          break;
        case "2":
          appVersion = '2';
          $('#Body').addClass('v2');
          cardTemplateSource = document.getElementById("Card-Template-2").innerHTML;
          console.log("showing version "+vNum);
          break;
        case "3":
          appVersion = '3';
          $('#Body').addClass('v3');
          cardTemplateSource = document.getElementById("Card-Template-3").innerHTML;
          console.log("showing version "+vNum);
          break;
        default:
          appVersion = '1';
          $('#Body').addClass('v1');
          cardTemplateSource = document.getElementById("Card-Template-1").innerHTML;
          console.log("showing default version");
      }

      panelTemplateSource = document.getElementById("Panel-Template").innerHTML;

      // sprinkle some magic dust
      cardTemplateClean = Handlebars.compile(cardTemplateSource);
      panelTemplateClean = Handlebars.compile(panelTemplateSource);

      // get data for each question set...

      // depression questions
      depressionQuestions = data.surveys.depression.questions;
      // belief questions
      beliefQuestions = data.surveys.beliefs.questions;
      // anxiety questions
      anxietyQuestions = data.surveys.anxiety.questions;
      // insomnia questions
      insomniaQuestions = data.surveys.insomnia.questions;

      // check for section query string
      const qsSection = params.get("section");

      // load the first set of questions
      switch(qsSection){
        case "depression":
          changeSection('depression');
          break;
        case "anxiety":
          changeSection('anxiety');
          break;
        case "beliefs":
          changeSection('beliefs');
          break;
        case "insomnia":
          changeSection('insomnia');
          break;
        default:
          changeSection('insomnia');
      }


      /////////////////////////////////
      ////// event handlers  //////////
      /////////////////////////////////


      // do stuff when the user drags the slider
      $('#Card-Wrapper').on('input', '#myRange', function(){
        // we made a selection so enable the next button
        enableNext();
        var value = this.value;
        updateSliderValue(value);
      });

      $('#Card-Wrapper').on('click', '.answerTag', function(){
        $(this).addClass('on');
        $(this).siblings().removeClass('on');
        // we made a selection so enable the next button
        enableNext();
      });

      $('#Card-Wrapper').on('click', '.answerTagAutoAdvance', function(){
        $(this).addClass('on');
        $(this).siblings().removeClass('on');
        // we made a selection so auto-advance to the next question
        setTimeout(clickNext, 500);
      });

      $('#Card-Wrapper').on('click', '.answerRadio', function(){
        if(atLeastOneRadio()){
          // we made a selection so enable the next button
          enableNext();
        }
      });


      $('.overlayPanel').on('click', '#Btn_Start', function(){
        // close the overlay and remove its contents
        closeOverlay();
      });


      $('#Btn_Continue').click(function(){
        $('.finishedOverlay').fadeOut();
      });


      // next button /////////////////////
      ////////////////////////////////////

      $('#Btn_Next').click(function(){
        var goToNum;
        // enable or disable previous button
        if(numCurrentQ == 0){
            numCurrentQ++;
            goToNum = numCurrentQ;
            updateScreen(goToNum);
            enablePrevious();
        }else if(numCurrentQ == numTotalQ - 1){
          // WE HAVE REACHED THE LAST QUESTION
            showFinishedOverlay();
          // go to the next section...
          // order should be insomnia, depression, anxiety, beliefs
          switch(currentSection){
            case 'insomnia':
              changeSection('depression');
              break;
            case 'depression':
              changeSection('anxiety');
              break;
            case 'anxiety':
              changeSection('beliefs');
              break;
            case 'beliefs':
              // showEndScreen();
              changeSection('insomnia');
              // instead of looping back to insomnia we should show a finished screen here
              break;
            default:
              console.log('theres a problem with this statement');
          }
        }else{
          numCurrentQ++;
          goToNum = numCurrentQ;
          updateScreen(goToNum);
        }
      });

      // previous button /////////////////////
      ////////////////////////////////////////

      $('#Btn_Previous').click(function(){

        // show or hide previous button
        if(numCurrentQ > 0){
          numCurrentQ--;
        }

        var goToNum = numCurrentQ;
        updateScreen(goToNum);
      });


    }); ////////////////////////// dom ready ////////////////////////////////


    /////////////////////////////////
    ////// methods //////////////////
    /////////////////////////////////

    function updateSliderValue(val){
      $('#rangeOutput').html(val);
    }

    function closeOverlay(){
      // hide the overlay panel and remove its contents
      $('.overlayPanel').fadeOut('fast');
      $('.overlayPanel').empty();
    }

    function changeSection(newSection){

      // set the section name
      currentSection = newSection;

      // show or hide the next button
      if(appVersion == '3' && currentSection == 'beliefs'){
        showNext();
      }

      switch(newSection){
        case 'beliefs':
          questionSet = beliefQuestions;
          break;
        case 'depression':
          questionSet = depressionQuestions;
          break;
        case 'anxiety':
          questionSet = anxietyQuestions;
          break;
        case 'insomnia':
          questionSet = insomniaQuestions;
          break;
        default:
          console.log('im not sure where to go, check change section');
      }

      // get questions length
      numTotalQ = questionSet.length;

      showOverlay(newSection);
      updateScreen(0);

    }


    function updateScreen(goToNum){

      var newScreenNum = goToNum;

      // if this is the first question in the set then disable the previous button
      if(newScreenNum == 0){
        disablePrevious();
      }else{
        enablePrevious();
      }

      // update current question variable
      numCurrentQ = newScreenNum;

      // disable next button
      // next gets enabled when a selection is made
      disableNext();

      // get current question text
      questionText = questionSet[numCurrentQ].question;
      // get answers for current question
      answers = questionSet[numCurrentQ].answers;
      // update current question number for display
      currentQuestionNum = newScreenNum + 1; // normalize

      // add data to the template
      var cardTemplateDirty = cardTemplateClean(questionSet[newScreenNum]);

      // show the people
      $('#Wrapper').fadeOut('fast',function(){
        $('#Card-Wrapper').html(cardTemplateDirty);
        updateHeader();
        updateProgressBar();
        if(currentSection == 'beliefs'){
          $('#SlideContainer').show();

          $('.slideRibbon').draggable({
            axis:"x",
            containment: "parent",
            //snap: '.snaptarget',
            grid: [ 80, 0 ],
            drag: function( event, ui ) {
              enableNext();
              var loc = ui.position.left;
              var item;
              switch(loc){
                case 0:
                  // 10
                  item = '.item10';
                  break;
                case 80:
                  // 9
                  item = '.item9';
                  break;
                case 160:
                  // 8
                  item = '.item8';
                  break;
                case 240:
                  // 7
                  item = '.item7';
                  break;
                case 320:
                  // 6
                  item = '.item6';
                  break;
                case 400:
                  // 5
                  item = '.item5';
                  break;
                case 480:
                  // 4
                  item = '.item4';
                  break;
                case 560:
                  // 3
                  item = '.item3';
                  break;
                case 640:
                  // 2
                  item = '.item2';
                  break;
                case 720:
                  //1
                  item = '.item1';
                  break;
                case 800:
                  // 0
                  item = '.item0';
                  break;
                default:
                  console.log('position issue');
              }
              $('.slideItem').css('opacity','0.2');
              $(item).css('opacity','1.0');
            }
          });

        }
        $(this).fadeIn();
      });

    }

    function showOverlay(section){

      var panelContent;
      var data;

      switch(section){
        case 'beliefs':
          data = {
            panelHeading: "Beliefs about sleep",
            panelBody: "Several statements reflecting people’s beliefs and attitudes about sleep are in the following screens. Please indicate to what extent you personally agree or disagree with each statement. There is no right or wrong answer. For each statement, choose a number that best reflects your personal experience. Consider the whole scale, rather than only the extremes of the continuum.  This question set takes about <x> time.",
            btnLabel: "Start Quiz"
          };
          break;
        case 'anxiety':
          data = {
            panelHeading: "Anxiety Questionnaire",
            panelBody: "This set of questions asks about current anxiety levels. For each question, please select a response that best describes your answer. This question set takes about <x> time.",
            btnLabel: "Start Quiz"
          };
          break;
        case 'depression':
          data = {
            panelHeading: "Patient Health Questionnaire",
            panelBody: "This set of questions asks about mental health. For each question, please select a response that best describes your answer. This question set takes about <x> time.",
            btnLabel: "Start Quiz"
          };
          break;
        case 'insomnia':
          data = {
            panelHeading: "Current Insomnia",
            panelBody: "This set of questions asks about your current symptoms of insomnia. For each question, please select a response that best describes your answer. This question set takes about <x> time.",
            btnLabel: "Start Quiz"
          };
          break;
        default:
          console.log('problem loading overlay panel');
      }

      panelTemplateDirty = panelTemplateClean(data);
      $('.overlayPanel').html(panelTemplateDirty);
      $('.overlayPanel').show();
    }

    function showFinishedOverlay(){
      $('.finishedOverlay').show();
    }

    function updateHeader(){
      $('#HeaderText').html("Question "+currentQuestionNum+" of "+ numTotalQ);
    }

    function updateProgressBar(){

      var progressBarIncrement = Math.round(100 / numTotalQ);
      var progressBarPosition = progressBarIncrement * currentQuestionNum;
      var progressBarWidth = progressBarPosition+'%';

      $('.progressBar-bar').css("width",progressBarWidth);
    }

    // check if there is a radio button selected
    // this guy is not actually being used...
    function atLeastOneRadio() {
      return ($('input[type=radio]:checked').length > 0);
    }

    function clickNext(){
      $('#Btn_Next').click();
    }

    function hideNext(){
      $('#Btn_Next').hide();
    }

    function showNext(){
      $('#Btn_Next').show();
    }

    function disableNext(){
      // disable the next button
      $("#Btn_Next").attr("disabled", true);
      $('#Btn_Next').addClass('disabled');
    }

    function disablePrevious(){
      // disable the previous button
      $("#Btn_Previous").attr("disabled", true);
      $('#Btn_Previous').addClass('disabled');
    }

    function enableNext(){
      // enable the next button
      $('#Btn_Next').removeAttr("disabled");
      $('#Btn_Next').removeClass('disabled');
    }

    function enablePrevious(){
      // disable the previous button
      $("#Btn_Previous").removeAttr("disabled");
      $('#Btn_Previous').removeClass('disabled');
    }



  </script>
